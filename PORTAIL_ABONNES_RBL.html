<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•§ RedBull GOLD - Portail d'Activation d'Abonnement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --redbull-red: #FF0000;
            --redbull-dark: #1A1A2E;
            --redbull-accent: #EAEAEA;
            --redbull-blue: #0055aa;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--redbull-dark);
            color: var(--redbull-accent);
        }
        .card {
            background-color: #252540;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            padding: 2rem;
        }
        .btn-redbull {
            background-color: var(--redbull-red);
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }
        .btn-redbull:hover:not(:disabled) {
            background-color: #E00000;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
            transform: translateY(-1px);
        }
        .input-style {
            background-color: #1A1A2E; 
            border-color: var(--redbull-blue); 
            color: #E2E8F0; 
        }
        .input-style:focus {
             border-color: var(--redbull-red);
             box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.3);
        }
        .private-header {
            border-bottom: 3px solid var(--redbull-red);
            padding-bottom: 0.5rem;
            color: #FFD700;
        }
        .info-block {
            background-color: #1A3A5A;
            border-left: 5px solid #FFD700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FF0000;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 flex items-center justify-center">

    <div id="app-container" class="max-w-xl mx-auto w-full">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white leading-tight tracking-wider">
                Portail <span style="color: var(--redbull-red);">Abonn√©s GOLD</span>
            </h1>
            <p class="mt-2 text-lg text-gray-400">Entre ton code pour acc√©der √† ton service d'√©nergie garanti.</p>
        </header>

        <section id="access-section" class="card">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-500">üîí Activation du Code</h2>
            
            <p class="text-gray-300 mb-4">Veuillez entrer le code unique re√ßu lors de ton paiement :</p>
            
            <input type="text" id="activation-code-input" placeholder="Ex: RBL-M03-XXXX-YYYY"
                   class="w-full p-4 rounded-lg border input-style text-center font-mono text-xl tracking-wider uppercase">
            
            <button id="activate-button" onclick="checkAndActivateCode()" disabled
                    class="btn-redbull w-full transition-transform transform mt-6 flex items-center justify-center opacity-70">
                <span id="button-text">Connexion √† la base de donn√©es...</span>
                <div id="loading-indicator" class="loading-spinner ml-3 hidden"></div>
            </button>
            
            <div id="message-area" class="text-center text-sm mt-4 font-bold" style="min-height: 20px;"></div>
        </section>

        <section id="portal-content" class="card mt-8 hidden">
            <h2 class="text-3xl font-extrabold mb-6 private-header">üöÄ ACC√àS GOLD ACTIF</h2>
            
            <div id="status-info" class="space-y-4 text-sm">
                <div class="info-block p-4 rounded-lg">
                    <p class="font-bold text-lg text-yellow-300">Statut Abonnement : <span id="abo-status" class="font-mono text-xl">ACTIF</span></p>
                </div>
                <div class="info-block p-4 rounded-lg">
                    <p><span class="font-bold text-gray-300">Code Utilis√© :</span> <span id="used-code" class="font-mono break-all text-red-400"></span></p>
                    <p><span class="font-bold text-gray-300">Description :</span> <span id="code-description" class="text-yellow-100"></span></p>
                    <p><span class="font-bold text-gray-300">Activation :</span> <span id="activation-date"></span></p>
                    <p><span class="font-bold text-gray-300">Expiration :</span> <span id="expiration-date"></span></p>
                </div>
            </div>

            <button onclick="resetPortal()" class="btn-redbull w-full mt-6 bg-gray-600 hover:bg-gray-700">D√©connecter le Portail</button>
        </section>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // setLogLevel('Debug'); // D√©commenter ceci si vous avez besoin de voir les logs de Firebase dans la console

        // =================================================================
        // üîë VOS CONFIGURATIONS FIREBASE FINALES üîë
        // Cl√©s copi√©es de votre console Firebase (redbull-generateur)
        // =================================================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCOJzc9JW6Jb4yVbIRtSHtTSCBnXRwBVQg", 
            authDomain: "redbull-generateur.firebaseapp.com", 
            projectId: "redbull-generateur", 
            storageBucket: "redbull-generateur.firebasestorage.app", 
            messagingSenderId: "571773020357",
            appId: "1:571773020357:web:9bfa70ee5160c51f2168ac"
        };
        const APP_ID = FIREBASE_CONFIG.projectId || 'redbull-gold-app'; 
        // =================================================================

        let db;
        let auth;
        let isAuthReady = false;

        const activateButton = document.getElementById('activate-button');
        const buttonText = document.getElementById('button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageArea = document.getElementById('message-area');
        const codeInput = document.getElementById('activation-code-input');
        const accessSection = document.getElementById('access-section');
        const portalContent = document.getElementById('portal-content');

        function displayMessage(message, isError = false) {
            messageArea.textContent = message;
            messageArea.className = `text-center text-sm mt-4 font-bold ${isError ? 'text-red-500' : 'text-green-500'}`;
        }
        
        // Convertit un timestamp Firebase en date lisible
        function formatDate(timestamp) {
            if (!timestamp) return 'Non d√©fini';
            // G√®re les objets Timestamp de Firebase et les timestamps num√©riques
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); 
            return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function calculateExpiration(isTrial, durationMonths) {
            const now = new Date();
            let expirationDate = new Date(now);

            if (isTrial) {
                // 7 jours d'essai
                expirationDate.setDate(now.getDate() + 7);
            } else {
                // Nombre de mois
                expirationDate.setMonth(now.getMonth() + durationMonths);
            }
            return expirationDate;
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Connexion anonyme requise pour l'utilisation des r√®gles de s√©curit√© Firestore
                await signInAnonymously(auth);
                isAuthReady = true;
                activateButton.disabled = false;
                activateButton.classList.remove('opacity-70');
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                displayMessage("Pr√™t √† activer le code !", false);
            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                displayMessage("√âchec de la connexion √† la base de donn√©es. V√©rifiez vos cl√©s Firebase ou les r√®gles de s√©curit√©.", true);
                activateButton.disabled = true;
            }
        }
        
        window.checkAndActivateCode = async function() {
            if (!isAuthReady || !db) {
                 displayMessage("Connexion √† la base de donn√©es en cours...", true);
                 return;
            }

            const enteredCode = codeInput.value.trim().toUpperCase();
            if (enteredCode === "") {
                displayMessage("Veuillez entrer votre code.", true);
                return;
            }

            activateButton.disabled = true;
            buttonText.textContent = "V√©rification...";
            loadingIndicator.classList.remove('hidden');
            messageArea.textContent = "";

            try {
                const collectionPath = `/artifacts/${APP_ID}/public/data/redbull_codes`;
                const codesRef = collection(db, collectionPath);
                
                // Recherche du code
                const q = query(codesRef, where('code', '==', enteredCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayMessage("Erreur: Ce code n'existe pas ou n'est pas valide.", true);
                    return;
                }

                const docSnapshot = querySnapshot.docs[0];
                const codeData = docSnapshot.data();

                if (codeData.isUsed) {
                    // Si d√©j√† utilis√©, afficher les infos d'abonnement existantes
                    showActivePortal(codeData, enteredCode);
                    displayMessage(`Ce code a d√©j√† √©t√© activ√© le ${formatDate(codeData.activatedAt)}.`, false);
                    return;
                }
                
                // --- Le code est valide et non utilis√©, nous l'activons ---
                
                const duration = codeData.duration;
                const isTrial = codeData.isTrial;
                const expirationDate = calculateExpiration(isTrial, duration);

                const updatePayload = {
                    isUsed: true,
                    activatedAt: serverTimestamp(),
                    expiresAt: expirationDate.getTime() // Stocke le timestamp en millisecondes
                };

                // Mise √† jour du document dans Firestore
                await updateDoc(docSnapshot.ref, updatePayload);
                
                // Mise √† jour de l'objet de donn√©es local pour l'affichage
                codeData.isUsed = true;
                codeData.activatedAt = new Date(); // Utilise la date locale pour l'affichage imm√©diat
                codeData.expiresAt = expirationDate.getTime();
                
                showActivePortal(codeData, enteredCode);
                displayMessage("SUCC√àS ! Votre abonnement RedBull GOLD est maintenant actif !", false);

            } catch (error) {
                console.error("Erreur lors de la v√©rification/activation:", error);
                // Si vous voyez une erreur ici, v√©rifiez vos R√®gles de S√©curit√© (Permission Denied)
                displayMessage(`Erreur de connexion : ${error.message}. V√©rifiez vos R√®gles de S√©curit√© Firestore.`, true);
            } finally {
                activateButton.disabled = false;
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function showActivePortal(codeData, enteredCode) {
            // Masquer la section d'acc√®s
            accessSection.classList.add('hidden');
            
            // Afficher la section du contenu du portail
            portalContent.classList.remove('hidden');

            const expirationDate = new Date(codeData.expiresAt);
            const statusText = codeData.expiresAt > Date.now() ? 'ACTIF' : 'EXPIR√â';
            const statusColor = codeData.expiresAt > Date.now() ? 'text-green-400' : 'text-red-400';

            // Mettre √† jour les informations
            document.getElementById('abo-status').textContent = statusText;
            document.getElementById('abo-status').className = `font-mono text-xl ${statusColor}`;
            
            document.getElementById('used-code').textContent = enteredCode;
            document.getElementById('code-description').textContent = codeData.description || "N/A";
            document.getElementById('activation-date').textContent = formatDate(codeData.activatedAt);
            document.getElementById('expiration-date').textContent = formatDate(expirationDate);
            
            // Masquer le message de statut
            messageArea.textContent = "";
        }

        window.resetPortal = function() {
            accessSection.classList.remove('hidden');
            portalContent.classList.add('hidden');
            codeInput.value = "";
            displayMessage("Veuillez entrer un nouveau code si n√©cessaire.", false);
        }

        // Initialisation au chargement
        window.onload = initializeFirebase;
    </script>
</body>
</html>            background-color: #E00000;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
            transform: translateY(-1px);
        }
        .input-style {
            background-color: #1A1A2E; 
            border-color: var(--redbull-blue); 
            color: #E2E8F0; 
        }
        .input-style:focus {
             border-color: var(--redbull-red);
             box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.3);
        }
        .private-header {
            border-bottom: 3px solid var(--redbull-red);
            padding-bottom: 0.5rem;
            color: #FFD700;
        }
        .info-block {
            background-color: #1A3A5A;
            border-left: 5px solid #FFD700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FF0000;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 flex items-center justify-center">

    <div id="app-container" class="max-w-xl mx-auto w-full">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white leading-tight tracking-wider">
                Portail <span style="color: var(--redbull-red);">Abonn√©s GOLD</span>
            </h1>
            <p class="mt-2 text-lg text-gray-400">Entre ton code pour acc√©der √† ton service d'√©nergie garanti.</p>
        </header>

        <section id="access-section" class="card">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-500">üîí Activation du Code</h2>
            
            <p class="text-gray-300 mb-4">Veuillez entrer le code unique re√ßu lors de ton paiement :</p>
            
            <input type="text" id="activation-code-input" placeholder="Ex: RBL-M03-XXXX-YYYY"
                   class="w-full p-4 rounded-lg border input-style text-center font-mono text-xl tracking-wider uppercase">
            
            <button id="activate-button" onclick="checkAndActivateCode()" disabled
                    class="btn-redbull w-full transition-transform transform mt-6 flex items-center justify-center opacity-70">
                <span id="button-text">Connexion √† la base de donn√©es...</span>
                <div id="loading-indicator" class="loading-spinner ml-3 hidden"></div>
            </button>
            
            <div id="message-area" class="text-center text-sm mt-4 font-bold" style="min-height: 20px;"></div>
        </section>

        <section id="portal-content" class="card mt-8 hidden">
            <h2 class="text-3xl font-extrabold mb-6 private-header">üöÄ ACC√àS GOLD ACTIF</h2>
            
            <div id="status-info" class="space-y-4 text-sm">
                <div class="info-block p-4 rounded-lg">
                    <p class="font-bold text-lg text-yellow-300">Statut Abonnement : <span id="abo-status" class="font-mono text-xl">ACTIF</span></p>
                </div>
                <div class="info-block p-4 rounded-lg">
                    <p><span class="font-bold text-gray-300">Code Utilis√© :</span> <span id="used-code" class="font-mono break-all text-red-400"></span></p>
                    <p><span class="font-bold text-gray-300">Description :</span> <span id="code-description" class="text-yellow-100"></span></p>
                    <p><span class="font-bold text-gray-300">Activation :</span> <span id="activation-date"></span></p>
                    <p><span class="font-bold text-gray-300">Expiration :</span> <span id="expiration-date"></span></p>
                </div>
            </div>

            <button onclick="resetPortal()" class="btn-redbull w-full mt-6 bg-gray-600 hover:bg-gray-700">D√©connecter le Portail</button>
        </section>
        
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        // =================================================================
        // üîë VOS CONFIGURATIONS FIREBASE FINALES üîë
        // CL√âS R√âCUP√âR√âES DE LA CONSOLE FIREBASE
        // =================================================================
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyCOJzc9JW6Jb4yVbIRtSHtTSCBnXRwBVQg", 
            authDomain: "redbull-generateur.firebaseapp.com", 
            projectId: "redbull-generateur", 
            storageBucket: "redbull-generateur.firebasestorage.app", 
            messagingSenderId: "571773020357",
            appId: "1:571773020357:web:9bfa70ee5160c51f2168ac"
        };
        const APP_ID = FIREBASE_CONFIG.projectId || 'redbull-gold-app'; 
        // =================================================================

        let db;
        let auth;
        let isAuthReady = false;

        const activateButton = document.getElementById('activate-button');
        const buttonText = document.getElementById('button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageArea = document.getElementById('message-area');
        const codeInput = document.getElementById('activation-code-input');
        const accessSection = document.getElementById('access-section');
        const portalContent = document.getElementById('portal-content');

        function displayMessage(message, isError = false) {
            messageArea.textContent = message;
            messageArea.className = `text-center text-sm mt-4 font-bold ${isError ? 'text-red-500' : 'text-green-500'}`;
        }
        
        // Convertit un timestamp Firebase en date lisible
        function formatDate(timestamp) {
            if (!timestamp) return 'Non d√©fini';
            // G√®re les objets Timestamp de Firebase et les timestamps num√©riques
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp); 
            return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function calculateExpiration(isTrial, durationMonths) {
            const now = new Date();
            let expirationDate = new Date(now);

            if (isTrial) {
                // 7 jours d'essai
                expirationDate.setDate(now.getDate() + 7);
            } else {
                // Nombre de mois
                expirationDate.setMonth(now.getMonth() + durationMonths);
            }
            return expirationDate;
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                isAuthReady = true;
                activateButton.disabled = false;
                activateButton.classList.remove('opacity-70');
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                displayMessage("Pr√™t √† activer le code !", false);
            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                displayMessage("√âchec de la connexion √† la base de donn√©es. V√©rifiez vos cl√©s Firebase ou les r√®gles de s√©curit√©.", true);
                activateButton.disabled = true;
            }
        }
        
        window.checkAndActivateCode = async function() {
            if (!isAuthReady || !db) {
                 displayMessage("Connexion √† la base de donn√©es en cours...", true);
                 return;
            }

            const enteredCode = codeInput.value.trim().toUpperCase();
            if (enteredCode === "") {
                displayMessage("Veuillez entrer votre code.", true);
                return;
            }

            activateButton.disabled = true;
            buttonText.textContent = "V√©rification...";
            loadingIndicator.classList.remove('hidden');
            messageArea.textContent = "";

            try {
                const collectionPath = `/artifacts/${APP_ID}/public/data/redbull_codes`;
                const codesRef = collection(db, collectionPath);
                
                // Recherche du code
                const q = query(codesRef, where('code', '==', enteredCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayMessage("Erreur: Ce code n'existe pas ou n'est pas valide.", true);
                    return;
                }

                const docSnapshot = querySnapshot.docs[0];
                const codeData = docSnapshot.data();

                if (codeData.isUsed) {
                    // Si d√©j√† utilis√©, afficher les infos d'abonnement existantes
                    showActivePortal(codeData, enteredCode);
                    displayMessage(`Ce code a d√©j√† √©t√© activ√© le ${formatDate(codeData.activatedAt)}.`, false);
                    return;
                }
                
                // --- Le code est valide et non utilis√©, nous l'activons ---
                
                const duration = codeData.duration;
                const isTrial = codeData.isTrial;
                const expirationDate = calculateExpiration(isTrial, duration);

                const updatePayload = {
                    isUsed: true,
                    activatedAt: serverTimestamp(),
                    expiresAt: expirationDate.getTime() // Stocke le timestamp en millisecondes
                };

                // Mise √† jour du document dans Firestore
                await updateDoc(docSnapshot.ref, updatePayload);
                
                // Mise √† jour de l'objet de donn√©es local pour l'affichage
                codeData.isUsed = true;
                codeData.activatedAt = new Date(); // Utilise la date locale pour l'affichage imm√©diat
                codeData.expiresAt = expirationDate.getTime();
                
                showActivePortal(codeData, enteredCode);
                displayMessage("SUCC√àS ! Votre abonnement RedBull GOLD est maintenant actif !", false);

            } catch (error) {
                console.error("Erreur lors de la v√©rification/activation:", error);
                displayMessage(`Erreur de connexion : ${error.message}. R√©essayez.`, true);
            } finally {
                activateButton.disabled = false;
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function showActivePortal(codeData, enteredCode) {
            // Masquer la section d'acc√®s
            accessSection.classList.add('hidden');
            
            // Afficher la section du contenu du portail
            portalContent.classList.remove('hidden');

            const expirationDate = new Date(codeData.expiresAt);
            const statusText = codeData.expiresAt > Date.now() ? 'ACTIF' : 'EXPIR√â';
            const statusColor = codeData.expiresAt > Date.now() ? 'text-green-400' : 'text-red-400';

            // Mettre √† jour les informations
            document.getElementById('abo-status').textContent = statusText;
            document.getElementById('abo-status').className = `font-mono text-xl ${statusColor}`;
            
            document.getElementById('used-code').textContent = enteredCode;
            document.getElementById('code-description').textContent = codeData.description || "N/A";
            document.getElementById('activation-date').textContent = formatDate(codeData.activatedAt);
            document.getElementById('expiration-date').textContent = formatDate(expirationDate);
            
            // Masquer le message de statut
            messageArea.textContent = "";
        }

        window.resetPortal = function() {
            accessSection.classList.remove('hidden');
            portalContent.classList.add('hidden');
            codeInput.value = "";
            displayMessage("Veuillez entrer un nouveau code si n√©cessaire.", false);
        }

        // Initialisation au chargement
        window.onload = initializeFirebase;
    </script>
</body>
</html>                 return;
            }

            const enteredCode = codeInput.value.trim().toUpperCase();
            if (enteredCode === "") {
                displayMessage("Veuillez entrer votre code.", true);
                return;
            }

            activateButton.disabled = true;
            buttonText.textContent = "V√©rification...";
            loadingIndicator.classList.remove('hidden');
            messageArea.textContent = "";

            try {
                const collectionPath = `/artifacts/${APP_ID}/public/data/redbull_codes`;
                const codesRef = collection(db, collectionPath);
                
                // Recherche du code
                const q = query(codesRef, where('code', '==', enteredCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    displayMessage("Erreur: Ce code n'existe pas ou n'est pas valide.", true);
                    return;
                }

                const docSnapshot = querySnapshot.docs[0];
                const codeData = docSnapshot.data();

                if (codeData.isUsed) {
                    // Si d√©j√† utilis√©, afficher les infos d'abonnement existantes
                    showActivePortal(codeData, enteredCode);
                    displayMessage(`Ce code a d√©j√† √©t√© activ√© le ${formatDate(codeData.activatedAt)}.`, false);
                    return;
                }
                
                // --- Le code est valide et non utilis√©, nous l'activons ---
                
                const duration = codeData.duration;
                const isTrial = codeData.isTrial;
                const expirationDate = calculateExpiration(isTrial, duration);

                const updatePayload = {
                    isUsed: true,
                    activatedAt: serverTimestamp(),
                    expiresAt: expirationDate.getTime() // Stocke le timestamp en millisecondes
                };

                // Mise √† jour du document dans Firestore
                await updateDoc(docSnapshot.ref, updatePayload);
                
                // Mise √† jour de l'objet de donn√©es local pour l'affichage
                codeData.isUsed = true;
                codeData.activatedAt = new Date(); // Utilise la date locale pour l'affichage imm√©diat
                codeData.expiresAt = expirationDate.getTime();
                
                showActivePortal(codeData, enteredCode);
                displayMessage("SUCC√àS ! Votre abonnement RedBull GOLD est maintenant actif !", false);

            } catch (error) {
                console.error("Erreur lors de la v√©rification/activation:", error);
                displayMessage(`Erreur de connexion : ${error.message}. R√©essayez.`, true);
            } finally {
                activateButton.disabled = false;
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        function showActivePortal(codeData, enteredCode) {
            // Masquer la section d'acc√®s
            accessSection.classList.add('hidden');
            
            // Afficher la section du contenu du portail
            portalContent.classList.remove('hidden');

            const expirationDate = new Date(codeData.expiresAt);
            const statusText = codeData.expiresAt > Date.now() ? 'ACTIF' : 'EXPIR√â';
            const statusColor = codeData.expiresAt > Date.now() ? 'text-green-400' : 'text-red-400';

            // Mettre √† jour les informations
            document.getElementById('abo-status').textContent = statusText;
            document.getElementById('abo-status').className = `font-mono text-xl ${statusColor}`;
            
            document.getElementById('used-code').textContent = enteredCode;
            document.getElementById('code-description').textContent = codeData.description || "N/A";
            document.getElementById('activation-date').textContent = formatDate(codeData.activatedAt);
            document.getElementById('expiration-date').textContent = formatDate(expirationDate);
            
            // Masquer le message de statut
            messageArea.textContent = "";
        }

        window.resetPortal = function() {
            accessSection.classList.remove('hidden');
            portalContent.classList.add('hidden');
            codeInput.value = "";
            displayMessage("Veuillez entrer un nouveau code si n√©cessaire.", false);
        }

        // Initialisation au chargement
        window.onload = initializeFirebase;
    </script>
</body>
</html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•§ RedBull GOLD - Portail d'Activation d'Abonnement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --redbull-red: #FF0000;
            --redbull-dark: #1A1A2E;
            --redbull-accent: #EAEAEA;
            --redbull-blue: #0055aa;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--redbull-dark);
            color: var(--redbull-accent);
        }
        .card {
            background-color: #252540;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            padding: 2rem;
        }
        .btn-redbull {
            background-color: var(--redbull-red);
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }
        .btn-redbull:hover {
            background-color: #E00000;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
            transform: translateY(-1px);
        }
        .input-style {
            background-color: #1A1A2E; 
            border-color: var(--redbull-blue); 
            color: #E2E8F0; 
        }
        .input-style:focus {
             border-color: var(--redbull-red);
             box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.3);
        }
        .private-header {
            border-bottom: 3px solid var(--redbull-red);
            padding-bottom: 0.5rem;
            color: #FFD700;
        }
        .info-block {
            background-color: #1A3A5A;
            border-left: 5px solid #FFD700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FF0000;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 flex items-center justify-center">

    <div id="app-container" class="max-w-xl mx-auto w-full">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white leading-tight tracking-wider">
                Portail <span style="color: var(--redbull-red);">Abonn√©s GOLD</span>
            </h1>
            <p class="mt-2 text-lg text-gray-400">Entre ton code pour acc√©der √† ton service d'√©nergie garanti.</p>
        </header>

        <section id="access-section" class="card">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-500">üîí Activation du Code</h2>
            
            <p class="text-gray-300 mb-4">Veuillez entrer le code unique re√ßu lors de ton paiement :</p>
            
            <input type="text" id="activation-code-input" placeholder="Ex: RBL-M03-XXXX-YYYY"
                   class="w-full p-4 rounded-lg border input-style text-center font-mono text-xl tracking-wider uppercase">
            
            <button id="activate-button" onclick="checkAndActivateCode()" 
                    class="btn-redbull w-full transition-transform transform mt-6 flex items-center justify-center">
                <span id="button-text">Activer & D√©bloquer l'Acc√®s</span>
                <div id="loading-indicator" class="loading-spinner ml-3 hidden"></div>
            </button>
            
            <div id="message-area" class="text-center text-sm mt-4 font-bold" style="min-height: 20px;"></div>
        </section>

        <section id="private-content" class="card mt-8 hidden">
            <h2 class="text-3xl font-bold mb-6 private-header text-center">‚úÖ ACC√àS VALID√â !</h2>
            
            <div class="space-y-4">
                <div class="info-block p-4 rounded-lg">
                    <p class="text-sm text-gray-300">Description de l'abonnement :</p>
                    <p id="subscription-description" class="text-xl font-bold text-white">Chargement...</p>
                </div>
                
                <div class="info-block p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-300">Statut / Expiration :</p>
                        <p id="expiration-status" class="text-xl font-bold text-green-400">Chargement...</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-red-400 pt-4">üöÄ INSTRUCTIONS DE RETRAIT IMM√âDIAT</h3>
                
                <ul class="space-y-3 text-left">
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">1.</span> 
                        <span class="flex-1"> **Confirmer la Commande :** Envoie imm√©diatement un message au gestionnaire **[Ton Num√©ro de T√©l√©phone / Discord / etc.]** pour sp√©cifier tes go√ªts.</span>
                    </li>
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">2.</span> 
                        <span class="flex-1"> **Point de Retrait :** Le stock est disponible au casier **[Ton Num√©ro]** ou zone habituelle (heure de la pause).</span>
                    </li>
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">3.</span> 
                        <span class="flex-1"> **Code Utilis√© :** Ce code est maintenant marqu√© comme utilis√©. Tu recevras le prochain lors de ton renouvellement.</span>
                    </li>
                </ul>
            </div>
        </section>
        
        <footer class="text-center mt-6 text-xs text-gray-600">
            Propuls√© par Firebase & Gemini. S√©curit√© de code garantie.
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Erreur de parsing de la configuration Firebase:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;

        const codeInput = document.getElementById('activation-code-input');
        const activateButton = document.getElementById('activate-button');
        const buttonText = document.getElementById('button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageArea = document.getElementById('message-area');
        const privateContent = document.getElementById('private-content');
        const subDescription = document.getElementById('subscription-description');
        const expirationStatus = document.getElementById('expiration-status');

        function displayMessage(message, isError = false) {
            messageArea.textContent = message;
            messageArea.className = `text-center text-sm mt-4 font-bold ${isError ? 'text-red-500' : 'text-green-500'}`;
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
        }

        function calculateExpirationDate(data) {
            const now = new Date();
            const expires = new Date(now);
            
            if (data.isTrial) {
                expires.setDate(now.getDate() + 7);
            } else if (data.duration && data.duration > 0) {
                expires.setMonth(now.getMonth() + data.duration);
            } else {
                expires.setMonth(now.getMonth() + 1);
            }

            return expires;
        }
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                displayMessage("√âchec de la connexion √† la base de donn√©es. Veuillez r√©essayer.", true);
            }
        }
        
        window.checkAndActivateCode = async function() {
            if (!isAuthReady || !db) {
                displayMessage("Connexion √† la base de donn√©es en cours, veuillez patienter.", true);
                return;
            }
            
            const enteredCode = codeInput.value.toUpperCase().trim();
            if (!enteredCode) {
                displayMessage("Veuillez entrer un code.", true);
                return;
            }

            activateButton.disabled = true;
            buttonText.textContent = "V√©rification...";
            loadingIndicator.classList.remove('hidden');
            messageArea.textContent = "";

            try {
                const collectionPath = `/artifacts/${appId}/public/data/redbull_codes`;
                
                const codesQuery = query(
                    collection(db, collectionPath),
                    where('code', '==', enteredCode)
                );
                
                const querySnapshot = await getDocs(codesQuery);

                if (querySnapshot.empty) {
                    displayMessage("Code invalide ou inexistant. V√©rifiez la saisie.", true);
                    return;
                }

                const codeDoc = querySnapshot.docs[0];
                const codeData = codeDoc.data();
                
                if (codeData.isUsed) {
                    let message = "Ce code a d√©j√† √©t√© utilis√©/activ√©.";
                    if (codeData.expiresAt && codeData.activatedAt) {
                        message += ` Il a √©t√© activ√© le ${formatDate(new Date(codeData.activatedAt.toDate()))}.`;
                    }
                    displayMessage(message, true);
                    return;
                }

                const expirationDate = calculateExpirationDate(codeData);
                const formattedExpiration = formatDate(expirationDate);
                
                await updateDoc(doc(db, collectionPath, codeDoc.id), {
                    isUsed: true,
                    activatedAt: serverTimestamp(),
                    expiresAt: expirationDate.getTime(),
                    activatedBy: auth.currentUser.uid
                });
                
                const durationText = codeData.isTrial ? 'ESSAI GRATUIT (7 jours)' : `${codeData.duration} MOIS d'abonnement`;
                
                subDescription.textContent = codeData.description || `Abonnement : ${durationText}`;
                expirationStatus.textContent = `Expire le ${formattedExpiration}`;
                
                displayMessage(`Abonnement valid√© ! Acc√®s d√©bloqu√© jusqu'au ${formattedExpiration}.`);
                
                document.getElementById('access-section').classList.add('hidden');
                privateContent.classList.remove('hidden');

            } catch (error) {
                console.error("Erreur lors de l'activation du code:", error);
                displayMessage("Une erreur interne est survenue. Code non activ√©. R√©essayez.", true);
            } finally {
                activateButton.disabled = false;
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>


