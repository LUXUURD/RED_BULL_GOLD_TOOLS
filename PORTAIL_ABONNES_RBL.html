<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü•§ RedBull GOLD - Portail d'Activation d'Abonnement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --redbull-red: #FF0000;
            --redbull-dark: #1A1A2E;
            --redbull-accent: #EAEAEA;
            --redbull-blue: #0055aa;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--redbull-dark);
            color: var(--redbull-accent);
        }
        .card {
            background-color: #252540;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            padding: 2rem;
        }
        .btn-redbull {
            background-color: var(--redbull-red);
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }
        .btn-redbull:hover {
            background-color: #E00000;
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
            transform: translateY(-1px);
        }
        .input-style {
            background-color: #1A1A2E; 
            border-color: var(--redbull-blue); 
            color: #E2E8F0; 
        }
        .input-style:focus {
             border-color: var(--redbull-red);
             box-shadow: 0 0 0 3px rgba(255, 0, 0, 0.3);
        }
        .private-header {
            border-bottom: 3px solid var(--redbull-red);
            padding-bottom: 0.5rem;
            color: #FFD700;
        }
        .info-block {
            background-color: #1A3A5A;
            border-left: 5px solid #FFD700;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #FF0000;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-10 flex items-center justify-center">

    <div id="app-container" class="max-w-xl mx-auto w-full">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white leading-tight tracking-wider">
                Portail <span style="color: var(--redbull-red);">Abonn√©s GOLD</span>
            </h1>
            <p class="mt-2 text-lg text-gray-400">Entre ton code pour acc√©der √† ton service d'√©nergie garanti.</p>
        </header>

        <section id="access-section" class="card">
            <h2 class="text-2xl font-bold mb-6 text-center text-red-500">üîí Activation du Code</h2>
            
            <p class="text-gray-300 mb-4">Veuillez entrer le code unique re√ßu lors de ton paiement :</p>
            
            <input type="text" id="activation-code-input" placeholder="Ex: RBL-M03-XXXX-YYYY"
                   class="w-full p-4 rounded-lg border input-style text-center font-mono text-xl tracking-wider uppercase">
            
            <button id="activate-button" onclick="checkAndActivateCode()" 
                    class="btn-redbull w-full transition-transform transform mt-6 flex items-center justify-center">
                <span id="button-text">Activer & D√©bloquer l'Acc√®s</span>
                <div id="loading-indicator" class="loading-spinner ml-3 hidden"></div>
            </button>
            
            <div id="message-area" class="text-center text-sm mt-4 font-bold" style="min-height: 20px;"></div>
        </section>

        <section id="private-content" class="card mt-8 hidden">
            <h2 class="text-3xl font-bold mb-6 private-header text-center">‚úÖ ACC√àS VALID√â !</h2>
            
            <div class="space-y-4">
                <div class="info-block p-4 rounded-lg">
                    <p class="text-sm text-gray-300">Description de l'abonnement :</p>
                    <p id="subscription-description" class="text-xl font-bold text-white">Chargement...</p>
                </div>
                
                <div class="info-block p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-300">Statut / Expiration :</p>
                        <p id="expiration-status" class="text-xl font-bold text-green-400">Chargement...</p>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-red-400 pt-4">üöÄ INSTRUCTIONS DE RETRAIT IMM√âDIAT</h3>
                
                <ul class="space-y-3 text-left">
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">1.</span> 
                        <span class="flex-1"> **Confirmer la Commande :** Envoie imm√©diatement un message au gestionnaire **[Ton Num√©ro de T√©l√©phone / Discord / etc.]** pour sp√©cifier tes go√ªts.</span>
                    </li>
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">2.</span> 
                        <span class="flex-1"> **Point de Retrait :** Le stock est disponible au casier **[Ton Num√©ro]** ou zone habituelle (heure de la pause).</span>
                    </li>
                    <li class="bg-gray-700 p-3 rounded-lg flex items-center">
                        <span class="text-red-500 font-extrabold mr-3 text-2xl">3.</span> 
                        <span class="flex-1"> **Code Utilis√© :** Ce code est maintenant marqu√© comme utilis√©. Tu recevras le prochain lors de ton renouvellement.</span>
                    </li>
                </ul>
            </div>
        </section>
        
        <footer class="text-center mt-6 text-xs text-gray-600">
            Propuls√© par Firebase & Gemini. S√©curit√© de code garantie.
        </footer>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Erreur de parsing de la configuration Firebase:", e);
        }
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let isAuthReady = false;

        const codeInput = document.getElementById('activation-code-input');
        const activateButton = document.getElementById('activate-button');
        const buttonText = document.getElementById('button-text');
        const loadingIndicator = document.getElementById('loading-indicator');
        const messageArea = document.getElementById('message-area');
        const privateContent = document.getElementById('private-content');
        const subDescription = document.getElementById('subscription-description');
        const expirationStatus = document.getElementById('expiration-status');

        function displayMessage(message, isError = false) {
            messageArea.textContent = message;
            messageArea.className = `text-center text-sm mt-4 font-bold ${isError ? 'text-red-500' : 'text-green-500'}`;
        }
        
        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
        }

        function calculateExpirationDate(data) {
            const now = new Date();
            const expires = new Date(now);
            
            if (data.isTrial) {
                expires.setDate(now.getDate() + 7);
            } else if (data.duration && data.duration > 0) {
                expires.setMonth(now.getMonth() + data.duration);
            } else {
                expires.setMonth(now.getMonth() + 1);
            }

            return expires;
        }
        
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                isAuthReady = true;

            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                displayMessage("√âchec de la connexion √† la base de donn√©es. Veuillez r√©essayer.", true);
            }
        }
        
        window.checkAndActivateCode = async function() {
            if (!isAuthReady || !db) {
                displayMessage("Connexion √† la base de donn√©es en cours, veuillez patienter.", true);
                return;
            }
            
            const enteredCode = codeInput.value.toUpperCase().trim();
            if (!enteredCode) {
                displayMessage("Veuillez entrer un code.", true);
                return;
            }

            activateButton.disabled = true;
            buttonText.textContent = "V√©rification...";
            loadingIndicator.classList.remove('hidden');
            messageArea.textContent = "";

            try {
                const collectionPath = `/artifacts/${appId}/public/data/redbull_codes`;
                
                const codesQuery = query(
                    collection(db, collectionPath),
                    where('code', '==', enteredCode)
                );
                
                const querySnapshot = await getDocs(codesQuery);

                if (querySnapshot.empty) {
                    displayMessage("Code invalide ou inexistant. V√©rifiez la saisie.", true);
                    return;
                }

                const codeDoc = querySnapshot.docs[0];
                const codeData = codeDoc.data();
                
                if (codeData.isUsed) {
                    let message = "Ce code a d√©j√† √©t√© utilis√©/activ√©.";
                    if (codeData.expiresAt && codeData.activatedAt) {
                        message += ` Il a √©t√© activ√© le ${formatDate(new Date(codeData.activatedAt.toDate()))}.`;
                    }
                    displayMessage(message, true);
                    return;
                }

                const expirationDate = calculateExpirationDate(codeData);
                const formattedExpiration = formatDate(expirationDate);
                
                await updateDoc(doc(db, collectionPath, codeDoc.id), {
                    isUsed: true,
                    activatedAt: serverTimestamp(),
                    expiresAt: expirationDate.getTime(),
                    activatedBy: auth.currentUser.uid
                });
                
                const durationText = codeData.isTrial ? 'ESSAI GRATUIT (7 jours)' : `${codeData.duration} MOIS d'abonnement`;
                
                subDescription.textContent = codeData.description || `Abonnement : ${durationText}`;
                expirationStatus.textContent = `Expire le ${formattedExpiration}`;
                
                displayMessage(`Abonnement valid√© ! Acc√®s d√©bloqu√© jusqu'au ${formattedExpiration}.`);
                
                document.getElementById('access-section').classList.add('hidden');
                privateContent.classList.remove('hidden');

            } catch (error) {
                console.error("Erreur lors de l'activation du code:", error);
                displayMessage("Une erreur interne est survenue. Code non activ√©. R√©essayez.", true);
            } finally {
                activateButton.disabled = false;
                buttonText.textContent = "Activer & D√©bloquer l'Acc√®s";
                loadingIndicator.classList.add('hidden');
            }
        }
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>
